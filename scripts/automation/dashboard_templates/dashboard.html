<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Experiment Monitoring Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .metric-card { margin-bottom: 20px; }
        .status-running { color: #28a745; }
        .status-completed { color: #6c757d; }
        .status-failed { color: #dc3545; }
        .chart-container { height: 400px; margin-bottom: 30px; }
        .refresh-indicator { position: fixed; top: 10px; right: 10px; }
        .experiment-card { border-left: 4px solid #007bff; }
        .progress-bar-container { margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1 class="mt-3 mb-4">
                    <i class="fas fa-chart-line"></i> Experiment Monitoring Dashboard
                    <span class="refresh-indicator">
                        <span id="refresh-status" class="badge bg-success">Live</span>
                        <small id="last-update" class="text-muted"></small>
                    </span>
                </h1>
            </div>
        </div>
        
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Active Experiments</h5>
                        <h3 id="active-count" class="text-primary">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Completed</h5>
                        <h3 id="completed-count" class="text-success">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Failed</h5>
                        <h3 id="failed-count" class="text-danger">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Success Rate</h5>
                        <h3 id="success-rate" class="text-info">-</h3>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Resource Usage Charts -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>System Resource Usage</h5>
                    </div>
                    <div class="card-body">
                        <div id="resource-chart" class="chart-container"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Experiment Progress</h5>
                    </div>
                    <div class="card-body">
                        <div id="progress-chart" class="chart-container"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Current Experiments -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Current Experiments</h5>
                    </div>
                    <div class="card-body">
                        <div id="current-experiments">
                            <p class="text-muted">No active experiments</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Results -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Recent Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="recent-results">
                            <p class="text-muted">No recent results</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Dashboard JavaScript
        let refreshInterval;
        
        function updateDashboard() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    updateSummaryCards(data);
                    updateCharts(data);
                    updateCurrentExperiments(data);
                    updateRecentResults(data);
                    
                    $('#last-update').text('Last updated: ' + new Date().toLocaleTimeString());
                    $('#refresh-status').removeClass('bg-danger').addClass('bg-success').text('Live');
                })
                .catch(error => {
                    console.error('Error updating dashboard:', error);
                    $('#refresh-status').removeClass('bg-success').addClass('bg-danger').text('Error');
                });
        }
        
        function updateSummaryCards(data) {
            $('#active-count').text(data.summary.active_experiments);
            $('#completed-count').text(data.summary.completed_experiments);
            $('#failed-count').text(data.summary.failed_experiments);
            $('#success-rate').text(data.summary.success_rate + '%');
        }
        
        function updateCharts(data) {
            // Resource usage chart
            if (data.resource_data && data.resource_data.length > 0) {
                const timestamps = data.resource_data.map(d => d.timestamp);
                const cpuData = data.resource_data.map(d => d.cpu_percent);
                const memoryData = data.resource_data.map(d => d.memory_percent);
                
                const resourceTraces = [
                    {
                        x: timestamps,
                        y: cpuData,
                        name: 'CPU %',
                        type: 'scatter',
                        mode: 'lines',
                        line: { color: '#ff7f0e' }
                    },
                    {
                        x: timestamps,
                        y: memoryData,
                        name: 'Memory %',
                        type: 'scatter',
                        mode: 'lines',
                        line: { color: '#2ca02c' }
                    }
                ];
                
                const resourceLayout = {
                    title: '',
                    xaxis: { title: 'Time' },
                    yaxis: { title: 'Usage %', range: [0, 100] },
                    margin: { t: 30, r: 30, b: 50, l: 50 }
                };
                
                Plotly.newPlot('resource-chart', resourceTraces, resourceLayout);
            }
            
            // Progress chart
            if (data.progress_data && data.progress_data.length > 0) {
                const progressTrace = {
                    x: data.progress_data.map(d => d.experiment_name),
                    y: data.progress_data.map(d => d.progress_percent),
                    type: 'bar',
                    marker: { color: '#1f77b4' }
                };
                
                const progressLayout = {
                    title: '',
                    xaxis: { title: 'Experiments' },
                    yaxis: { title: 'Progress %', range: [0, 100] },
                    margin: { t: 30, r: 30, b: 80, l: 50 }
                };
                
                Plotly.newPlot('progress-chart', [progressTrace], progressLayout);
            }
        }
        
        function updateCurrentExperiments(data) {
            const container = $('#current-experiments');
            
            if (data.current_experiments && data.current_experiments.length > 0) {
                let html = '';
                data.current_experiments.forEach(exp => {
                    const statusClass = `status-${exp.status}`;
                    const progressWidth = exp.progress_percent || 0;
                    
                    html += `
                        <div class="experiment-card card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="card-title">${exp.job_id}</h6>
                                        <p class="card-text">${exp.experiment_type}</p>
                                        <span class="badge ${statusClass}">${exp.status}</span>
                                    </div>
                                    <div class="text-end">
                                        <small class="text-muted">Started: ${exp.start_time}</small>
                                        <div class="progress-bar-container">
                                            <div class="progress">
                                                <div class="progress-bar" style="width: ${progressWidth}%">${progressWidth}%</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                container.html(html);
            } else {
                container.html('<p class="text-muted">No active experiments</p>');
            }
        }
        
        function updateRecentResults(data) {
            const container = $('#recent-results');
            
            if (data.recent_results && data.recent_results.length > 0) {
                let html = '<div class="table-responsive">';
                html += '<table class="table table-striped">';
                html += '<thead><tr><th>Job ID</th><th>Status</th><th>Duration</th><th>Accuracy</th><th>Fairness</th></tr></thead><tbody>';
                
                data.recent_results.forEach(result => {
                    const duration = result.duration ? `${result.duration.toFixed(1)}s` : 'N/A';
                    const accuracy = result.accuracy ? `${(result.accuracy * 100).toFixed(1)}%` : 'N/A';
                    const fairness = result.fairness ? result.fairness.toFixed(3) : 'N/A';
                    
                    html += `
                        <tr>
                            <td>${result.job_id}</td>
                            <td><span class="badge status-${result.status}">${result.status}</span></td>
                            <td>${duration}</td>
                            <td>${accuracy}</td>
                            <td>${fairness}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                container.html(html);
            } else {
                container.html('<p class="text-muted">No recent results</p>');
            }
        }
        
        // Auto-refresh every 5 seconds
        $(document).ready(function() {
            updateDashboard();
            refreshInterval = setInterval(updateDashboard, 5000);
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>